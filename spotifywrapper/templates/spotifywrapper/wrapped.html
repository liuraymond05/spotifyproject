{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Spotify Wrapped</title>
    <link rel="stylesheet" href="{% static 'spotifywrapped/wrapped.css' %}">
    <script src="{% static 'spotifywrapped/confetti.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="wrapper">
        <h1>My Spotify Wrapped</h1>
        <!-- % include 'spotifywrapper/banner.html' %} -->

        <!-- Form for selecting time range -->
        <form method="get" action="{% url 'top_spotify_data' %}">
            <label for="time_range">Select Time Range:</label>
            <select name="time_range" id="time_range">
                <option value="short_term" {% if selected_time_range == 'short_term' %}selected{% endif %}>Last 4 Weeks</option>
                <option value="medium_term" {% if selected_time_range == 'medium_term' %}selected{% endif %}>Last 6 Months</option>
                <option value="long_term" {% if selected_time_range == 'long_term' %}selected{% endif %}>Last Year</option>
            </select>
            <button type="submit">Apply</button>
        </form>

        <!-- Dynamic header based on selected time range -->
        <h1>Spotify Wrapped for the last
            {% if selected_time_range == 'short_term' %}4 weeks
            {% elif selected_time_range == 'medium_term' %}6 months
            {% elif selected_time_range == 'long_term' %}year
            {% endif %}
        </h1>

        <!-- Displaying dynamic data like top artists, tracks, etc. -->
        <div class="pic-container">
            <div id="silver-squiggle">
                <img src="../../static/spotifywrapped/silversquiggle.png" alt="Flower">
            </div>
            <div id="lavender">
                <img src="../../static/spotifywrapped/lavender.png" alt="Flower">
            </div>
        </div>

        <div class="animation-container">
            <div id="sun-or-moon"></div> <!-- The sun or moon image will appear here -->
        </div>

        <div class="carousel">
            <button class="arrow left" onclick="moveCarousel('left')">&#10094;</button>
            <div class="cards-container">
                <div class="card">
                    <h2>Welcome to Your Spotify Wrapped!</h2>
                    <p>Here's to your music taste {{ username }}!</p>
                </div>

                <div class="card">
                    <h2>Top Genre</h2>
                    <div id="cd-container">
                        <div id="cd"></div>
                        <div id="genre-name">{{ top_genre }}</div>
                    </div>
                </div>

                <canvas id="confetti"></canvas>

                <div class="card">
                    <h2>Top 3 Artists</h2>
                    <div class="artist-container">
                        {% for artist in top_artists %}
                            <div class="artist-card">
                                <img src="{{ artist.image }}" alt="{{ artist.name }}" class="artist-image">
                                <p class="artist-name">{{ artist.name }}</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="card">
                    <h2>Top Album</h2>
                    <div class="album-card-container">
                        <div class="album-card" id="album-card">
                            <div class="album-front">
                                <img src="{{ album_details.image }}" alt="Top Album" class="album-image">
                                <p><strong>Album:</strong> {{ album_details.name }}</p>
                            </div>
                            <div class="album-back">
                                <div class="album-details">
                                    <p><strong>Album:</strong> {{ album_details.name }}</p>
                                    <p><strong>Release Date:</strong> {{ album_details.release_date }}</p>
                                    <p><strong>Label:</strong> {{ album_details.details }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Top Song</h2>
                    <p>{{ top_song }}</p>
                    <div id="song-container">
                        <canvas id="waveform-canvas" width="600" height="200"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>Top Playlist</h2>
                    <div id="playlist-pulse-container">
                        <div id="pulse-circle">
                            <span id="playlist-name">{{ top_playlist }}</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Favorite Decade</h2>
                    <div id="vinyl-container">
                        <div id="vinyl"></div>
                        <div id="decade-number">{{ favorite_decade }}</div>
                    </div>
                </div>

                <div class="card" id="favorite-mood">
                    <h2>Favorite Mood</h2>
                    <p>{{ favorite_mood }}</p>
                </div>

                <div class="card">
                    <h2>Top 3 Tracks</h2>
                    <div class="tracks-list">
                        {% for track in top_tracks %}
                        <div class="track-card">
                            <div class="track-info">
                                <h4>{{ track.name }}</h4>
                                <p class="artist-name">by {{ track.artist }}</p>
                            </div>
                            {% if track.preview_url %}
                            <audio controls>
                                <source src="{{ track.preview_url }}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                            {% else %}
                            <p class="no-preview">No preview available</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="card" id="listening-habits">
                    <h2>Listening Habits</h2>
                    <p>You listen to music most at <strong>{{ peak_hour }}:00</strong>!</p>
                </div>

            </div>
            <button class="arrow right" onclick="moveCarousel('right')">&#10095;</button>
        </div>
    </div>

    <audio id="preview-audio" style="display:none" controls>
        Your browser does not support the audio element.
    </audio>

    <!-- Include JSON data safely using json_script -->
    <script id="top_artists" type="application/json">
        {{ top_artists|json_script:"top_artists" }}
    </script>
    <script id="top_tracks" type="application/json">
        {{ top_tracks|json_script:"top_tracks" }}
    </script>

    <!-- Form for saving data -->
    <form id="saveForm" method="post" action="{% url 'save_wrap' %}">
        {% csrf_token %}
        <input type="hidden" name="time_range" value="{{ selected_time_range }}">
        <button type="submit" id="saveButton">Save Wrapped</button>
    </form>
    <script>
        // Carousel Logic
        let currentIndex = 0;
        
    document.addEventListener("DOMContentLoaded", function() {
        // Hide the artist cards initially and apply the flip animation when the page loads
        const artistCards = document.querySelectorAll('.artist-card');
        artistCards.forEach(card => {
            card.classList.remove('visible'); // Ensure cards are hidden on load
        });

        // Initialize the confetti animation
        const confetti = new Confetti("confetti");
        confetti.start();
    });

    function moveCarousel(direction) {
        const container = document.querySelector('.cards-container');
        const cards = document.querySelectorAll('.card');
        const totalCards = cards.length;

        const cardWidth = cards[0].offsetWidth;

        if (direction === 'right') {
            currentIndex = (currentIndex + 1) % totalCards;
        } else if (direction === 'left') {
            currentIndex = (currentIndex - 1 + totalCards) % totalCards;
        }

        container.style.transform = `translateX(-${currentIndex * (cardWidth + 18)}px)`;
    }

    // Use AJAX to submit the form without redirecting
    $(document).ready(function() {
    $('#saveForm').on('submit', function(event) {
        event.preventDefault();  // Prevent default form submission

        // Fetch the JSON data safely from <script> tags
        const wrappedData = {
            top_artists: JSON.parse(document.getElementById('top_artists').textContent),
            top_tracks: JSON.parse(document.getElementById('top_tracks').textContent),
            top_genre: "{{ top_genre }}",
            favorite_mood: "{{ favorite_mood }}",
            top_playlist: "{{ top_playlist }}",
            favorite_decade: "{{ favorite_decade }}",
            peak_hour: {{ peak_hour }},
            time_range: $('#time_range').val(),  // Get the value of the selected time range
        };

        $.ajax({
            type: 'POST',
            url: $(this).attr('action'),  // Ensure this is the correct URL for saving data
            data: {
                'top_artists': JSON.stringify(wrappedData.top_artists),
                'top_tracks': JSON.stringify(wrappedData.top_tracks),
                'top_genre': wrappedData.top_genre,
                'favorite_mood': wrappedData.favorite_mood,
                'top_playlist': wrappedData.top_playlist,
                'favorite_decade': wrappedData.favorite_decade,
                'peak_hour': wrappedData.peak_hour,
                'time_range': wrappedData.time_range,  // Include the selected time range
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(),
            },
            success: function(response) {
                // Display success message
                alert('Your wrapped data has been saved!');
                console.log(response); // Optional debugging
            },
            error: function(xhr, errmsg, err) {
                // Handle error
                alert('Error saving your wrapped data. Please try again.');
                console.log(xhr.responseText); // Debugging
            }
        });
    });
});

</body>
</html>
